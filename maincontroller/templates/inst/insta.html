{% extends 'base.html' %}
{% block title %}INSTA парсер{% endblock title %}

{% load static %}
{% block side_css %}
    <style>
        .dropdown-input label {
            display: block;
            padding: 3px 20px 0 20px;
            clear: both;
            font-weight: 400;
            line-height: 1.42857143;
            color: #333;
            white-space: nowrap;
        }

        .scrollable-menu {
            height: auto;
            max-height: 200px;
            overflow-x: hidden;
        }
    </style>
{% endblock side_css %}

<div class="container col-lg-12 col-xl-10">
    <main role="main" class="pb-3">
        <form action="" method="post">
            {% csrf_token %}
            <div>
                {% block name_page %}Instagram{% endblock name_page %}
                {% block main_content %}
                    </div>
                    <table class="table table-striped table-hover text-center uk-table">
                        <thead>
                        <tr>
                            <th scope="col">#</th>
                            <th scope="col">Парсер</th>
                            <th scope="col">Состояние</th>
                            <th scope="col">Потоков</th>
                            <th scope="col">Страна</th>
                            <th scope="col">Город</th>
                            <th scope="col">Обработано</th>
                            <th scope="col">Осталось</th>
                            <th scope="col">Действие</th>
                            <th scope="col" style="padding: 0" class="custom-hover">
                                <a id='reloadBTN'>
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" id="animation"
                                         style="margin-top: -35px; margin-right: 5px;">
                                        <path d="M10.762 19.632l-.001.09.419.896c.177.39.01.85-.377 1.034-.256.12-.478.146-.666.077-.188-.068-.283-.103-.402-.358L8.36 18.422c-.179-.384-.008-.854.411-1.128l2.948-1.374a.785.785 0 0 1 1.033.376c.178.389.011.85-.375 1.034l-1.006.503c3.01.204 5.98-1.59 6.5-4.537a5.773 5.773 0 0 0-.973-4.337l-.094-.128a.91.91 0 0 1 .255-1.309 1.068 1.068 0 0 1 1.418.266l.052.07a7.704 7.704 0 0 1 1.298 5.783c-.742 4.205-4.786 6.69-9.065 5.99zm1.932-15.546l-.445-.955a.785.785 0 0 1 .376-1.034.785.785 0 0 1 1.034.376l1.375 2.949c.145.478-.026.947-.41 1.126l-2.948 1.375c-.257.12-.35.086-.539.017-.188-.067-.342-.23-.46-.487a.785.785 0 0 1 .375-1.034l.832-.398c-2.814.038-5.288 2.032-5.788 4.865a5.81 5.81 0 0 0 .434 3.423c.16.354.357.694.59 1.016a.818.818 0 0 1-.222 1.222l-.24.14a.899.899 0 0 1-1.167-.23 7.938 7.938 0 0 1-.776-1.332 7.754 7.754 0 0 1-.588-4.587c.715-4.057 4.472-6.828 8.567-6.452z"
                                              fill="#42526E" fill-rule="evenodd"/>
                                    </svg>
                                </a>
                            </th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for parser in parsers %}
                            <tr class="custom-tr">
                                <td scope="row"><span class='parser_id'>{{ parser.pk }}</span></td>
                                <td>{{ parser.name }}</td>
                                <td>{{ parser.address }}</td>
                                <td><span class="country" id='{{ parser.pk }}_country'></span></td>
                                <td><span class="city" id='{{ parser.pk }}_city'></span></td>
                                <td><span class="city" id='{{ parser.pk }}_age'></span></td>
                                <td><span class="processed_id" id='{{ parser.pk }}_procesedid'></span></td>
                                <td><span class="processed_photo" id='{{ parser.pk }}_processphoto'></span></td>
                                <td>
                                    <button href="#" data-id="{{ parser.pk }}"
                                            class="infoBTN uk-button uk-button-default custom-buttons"
                                            data-toggle="modal" data-target="#infoFilterModal" value="{{ parser.pk }}">
                                        <i uk-icon="info" aria-hidden="true"></i>
                                        <span hidden id="parserId">{{ parser.pk }}</span>
                                    </button>
                                    {% if parser.is_active %}
                                        <button href="#" data-id="{{ parser.pk }}" onclick="run('{{ parser.pk }}')"
                                                class="playBTN uk-button uk-button-default custom-buttons" disabled>
                                            <i uk-icon="play" aria-hidden="true"></i>
                                        </button>
                                    {% else %}
                                        <button href="#" data-id="{{ parser.pk }}" onclick="run('{{ parser.pk }}')"
                                                class="playBTN uk-button uk-button-default custom-buttons">
                                            <i uk-icon="play" aria-hidden="true"></i>
                                        </button>
                                    {% endif %}
                                    <button href="#" data-id="{{ parser.pk }}" onclick="pause('{{ parser.pk }}')"
                                            class="pauseBTN uk-button uk-button-default custom-buttons2">
                                        <i class="fa fa-pause" aria-hidden="true"></i>
                                        <span hidden id="settingsId">{{ parser.pk }}</span>
                                    </button>
                                    {% if parser.is_active %}
                                        <button href="#" data-id="{{ parser.pk }}" onclick="stop('{{ parser.pk }}')"
                                                class="stopBTN uk-button uk-button-default custom-buttons2">
                                            <i class="fa fa-stop" aria-hidden="true"></i>
                                        </button>
                                    {% else %}
                                        <button href="#" data-id="{{ parser.pk }}" onclick="stop('{{ parser.pk }}')"
                                                class="stopBTN uk-button uk-button-default custom-buttons2" disabled>
                                            <i class="fa fa-stop" aria-hidden="true"></i>
                                        </button>
                                    {% endif %}
                                    <button href="#" data-id="{{ parser.pk }}"
                                            class="settingBTN uk-button uk-button-default custom-buttons"
                                            data-toggle="modal" data-target="#createFilterModal">
                                        <i uk-icon="settings" aria-hidden="true"></i>
                                        <span hidden id="settingsId">{{ parser.pk }}</span>
                                    </button>
                                </td>
                                <td></td>
                            </tr>

                        {% endfor %}

                        </tbody>
                    </table>
                    </div>
                    <div class="modal fade" id="infoFilterModal" tabindex="-1" role="dialog"
                         aria-labelledby="infoFilterModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="infoFilterModalLabel">Информация об Instagram
                                        парсере</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div>
                                        <div class="form-group col-10">
                                            <h5>
                                                Параметры Instagram парсера
                                            </h5>
                                        </div>
                                        <div class="form-group col-6">
                                            <p>Состояние: <span id="parserStatus"></span></p>
                                            <p>Количество потоков: <span id="parserThread"></span></p>
                                            <p>Время начала работы: <span id="parserStartTime"></span></p>
                                        </div>
                                        <div class="form-group col-10">
                                            <p class="font-weight-bold">Фильтры парсера</p>
                                        </div>
                                        <div class="form-group col-10">
                                            <p>Теги: <span id="parserTags"></span></p>
                                            <p>Группы: <span id="parserGroups"></span></p>
                                            <p>Локация: <span id="parserLocation"></span></p>
                                            <p>Фотографий со страницы: <span id="parserPhotoByPage"></span></p>
                                            <p>Папок в пакете: <span id="parserFilesInPakage"></span></p>
                                        </div>
                                        <div class="form-group col-10">
                                            <p class="font-weight-bold">Парсер обработал</p>
                                            <p>Пользователей: <span id="parserParsedId"></span></p>
                                            <p>Страниц: <span id="parserParsedPages"></span></p>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <div class="m-auto">
                                        <button type="button" class="uk-button uk-button-default"
                                                data-dismiss="modal">Закрыть
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade" id="createFilterModal" tabindex="-1" role="dialog"
                         aria-labelledby="createFilterModalLabel" aria-hidden="true">
                        <div class="modal-dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="createFilterModalLabel">Создание фильтров Инстаграм
                                        парсера</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div>
                                        <div class="form-group ">
                                        <span class="font-weight-bold">
                                            Параметры фильтров Инстаграм парсера
                                        </span>
                                        </div>
                                        <div>
                                            <div class="form-group">
                                            <span>
                                                Поиск тега:
                                            </span>
                                            </div>
                                            <div class="row">
                                                <div class="row col-7">
                                                    <div class="col-9 pr-0">
                                                        <input type="text" class="form-control" id="TegInput"
                                                               list="tegs"
                                                               name="tegs"/>
                                                        <datalist id="tegs">
                                                            {% for tag in tags %}
                                                                <option value="{{ tag.name }}">{{ tag.name }} </option>
                                                            {% endfor %}
                                                        </datalist>
                                                    </div>
                                                    <div class="col-3 pl-0">
                                                        <button type="button"
                                                                class="uk-button uk-button-default custom-buttons2"
                                                                id="addNewTagBTN"><i class="fa fa-plus"
                                                                                     aria-hidden="true"></i></button>
                                                    </div>
                                                </div>
                                                <div class="col-5">
                                                    <div class="dropdown">
                                                        <button class="btn btn-default dropdown-toggle" type="button"
                                                                data-toggle="dropdown">
                                                            Выбрать теги: <span class="caret"></span>
                                                        </button>
                                                        <ul class="dropdown-menu scrollable-menu" id="addedTags">
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <div class="form-group">
                                            <span>
                                                Поиск группы:
                                            </span>
                                            </div>
                                            <div class="row">
                                                <div class="row col-7">
                                                    <div class="col-9 pr-0">
                                                        <input type="text" class="form-control" id="GroupInput"
                                                               list="groups" name="groups"/>
                                                        <datalist id="groups">
                                                            {% for group in groups %}
                                                                <option value="{{ group.inst_username }}">{{ group.inst_username }} </option>
                                                            {% endfor %}

                                                        </datalist>
                                                    </div>
                                                    <div class="col-3 pl-0">
                                                        <button type="button"
                                                                class="uk-button uk-button-default custom-buttons2"
                                                                id="addNewGroupBTN"><i class="fa fa-plus"
                                                                                       aria-hidden="true"></i></button>
                                                    </div>
                                                </div>
                                                <div class="col-5">
                                                    <div class="dropdown">
                                                        <button class="btn btn-default dropdown-toggle" type="button"
                                                                data-toggle="dropdown">
                                                            Выбрать группы: <span class="caret"></span>
                                                        </button>
                                                        <ul class="dropdown-menu scrollable-menu" id="addedGroups">
                                                        </ul>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row mt-2">
                                            <div class="form-group col-6">
                                                <label for="Thread">Количество потоков</label>
                                                <input type="number" class="form-control" id="Thread"
                                                       aria-describedby="ThreadHelp" required>
                                                <small id="ThreadHelp" class="form-text text-muted">Количество потоков
                                                    должно быть в диапазоне от 1 до 500.</small>
                                            </div>
                                            <div class="form-group col-6">
                                                <label for="Location">Локация</label>
                                                <input type="text" class="form-control" id="Location"
                                                       aria-describedby="LocationHelp" required>
                                                <small id="LocationHelp" class="form-text text-muted">Локация должна
                                                    быть на
                                                    английском языке.</small>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="form-group col-6">
                                                <label for="Photo">Максимум фото со страницы</label>
                                                <input type="number" class="form-control" id="Photo"
                                                       aria-describedby="PhotoHelp" required>
                                                <small id="PhotoHelp" class="form-text text-muted">Количество фото
                                                    должно
                                                    быть в диапазоне от 1 до 10.</small>
                                            </div>
                                            <div class="form-group col-6">
                                                <label for="Folder">Максимум папок в пакете</label>
                                                <input type="number" class="form-control" id="Folder"
                                                       aria-describedby="FolderHelp" required>
                                                <small id="FolderHelp" class="form-text text-muted">Количество папок
                                                    должно
                                                    быть в диапазоне от 1 до 500.</small>
                                            </div>
                                        </div>
                                        <div class="row">
                                            <div class="form-group col-6">
                                                <label for="PackAmount">Максимум пакетов</label>
                                                <input type="number" min=0 class="form-control" id="PackAmount"
                                                       aria-describedby="PackAmountHelp" required>
                                                <small id="PackAmountHelp" class="form-text text-muted">(необязательное
                                                    поле)</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="uk-button uk-button-default" data-dismiss="modal">
                                        Закрыть
                                    </button>
                                    <button type="submit" class="btn btn-primary settingApplyBTN">Создать парсер
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal fade" id="createParserModal" tabindex="-1" role="dialog"
                         aria-labelledby="createParserModalLabel" aria-hidden="true">
                        <div class="modal-dialog modal-sm">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="createParserModalLabel">Создание Инстаграм парсера</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <div>
                                        <div class="col-12">
                                            <div class="form-group">
                                            <span class="font-weight-bold">
                                                Параметры Инстаграм парсера
                                            </span>
                                            </div>
                                            <div class="form-group">
                                                <label for="Address">Название парсера</label>
                                                <input type="text" class="form-control" id="CreateName"
                                                       aria-describedby="NameHelp" required>
                                                <small id="NameHelp" class="form-text text-muted">Отображаемое в
                                                    статусе.</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="Address">Адрес</label>
                                                <input type="text" class="form-control" id="Address"
                                                       aria-describedby="AddressHelp" required>
                                                <small id="AddressHelp" class="form-text text-muted">IP адрес сервера
                                                    (без
                                                    порта).</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="Login">Логин</label>
                                                <input type="text" class="form-control" id="Login"
                                                       aria-describedby="LoginHelp" required>
                                                <small id="LoginHelp" class="form-text text-muted">Логин от виртуально
                                                    выделенного сервера.</small>
                                            </div>
                                            <div class="form-group">
                                                <label for="Password">Пароль</label>
                                                <input type="text" class="form-control" id="Password"
                                                       aria-describedby="PasswordHelp" required>
                                                <small id="PasswordHelp" class="form-text text-muted">Пароль от
                                                    виртуально
                                                    выделенного сервера.</small>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="modal-footer">
                                        <div class="m-auto">
                                            <button type="button" class="uk-button uk-button-default"
                                                    data-dismiss="modal">Закрыть
                                            </button>
                                            <button type="submit" class="uk-button uk-button-primary createApplyBTN">
                                                Создать
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                {% endblock main_content %}
</form>
</main>
</div>

{% block side_script %}

    <script src="{% static "jquery/dist/jquery.js" %}"></script>
    <script>
        $('#reloadBTN').on("click", function () {
            $('#animation').addClass("custom-animate");
            $('#reloadBTN').on('click', function () {
                for (let i of document.getElementsByClassName('parser_id')) {
                    console.log(i.innerText);
                    get_parser_status(i.innerText);
                }
            });
            setTimeout(() => {
                $('#animation').removeClass("custom-animate");
            }, 1000);
        });
    </script>
    <script>
        $('#proxyTypeSelect').on('change', function () {
            var proxyTypeSelect = $('#proxyTypeSelect').val();
            var proxyShow = document.getElementById('proxyTypeSock');
            if (proxyTypeSelect == 'socks') {
                proxyShow.style.display = "block";
            } else if (proxyTypeSelect == 'http') {
                var golo = $('#LoginProxy').val();
                $('#LoginProxy').val('');
                $('#PasswordProxy').val('');
                proxyShow.style.display = "none";
            }
        })
        $('.addProxyBTN').on('click', function () {
            var proxyType = $('#proxyTypeSelect').val();
            var proxyIp = $('#IpPort').val();
            var proxyLogin = $('#LoginProxy').val();
            var proxyPass = $('#PasswordProxy').val();
            $.ajax({
                url: '/vk/create_proxy/',
                method: 'POST',
                data: {
                    'proxyType': proxyType,
                    'proxyIp': proxyIp,
                    'proxyLogin': proxyLogin,
                    'proxyPass': proxyPass
                },
                success: function (result) {
                    if (result.success) {
                        Swal.fire({
                            title: 'Успешно!',
                            text: result.message,
                            icon: 'success',
                            timer: 3000,
                            showConfirmButton: true
                        }).then(() => {
                            window.location.href = '';
                        });
                    } else {
                        Swal.fire({
                            title: 'Ошибка!',
                            text: result.message,
                            icon: 'error',
                            timer: 4000,
                            showConfirmButton: true
                        });
                    }
                }
            })
        })

    </script>
    <script>
        function run(parsers_id) {
            console.log(parsers_id);
            $.ajax({
                url: '',
                method: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'parsers_id': parsers_id,
                    'action': 'run'
                },
                success: function (result) {
                    console.log('run');
                }
            })
        }


        function pause(parsers_id) {


            $.ajax({
                url: '/inst/pause_status/',
                method: 'GET',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'parsers_id': parsers_id
                },
                success: function (result) {
                    console.log(result);
                    set_status(result['status_pause'], parsers_id);

                }
            })
        }

        function set_status(pause_status, parsers_id) {
            if (pause_status == 'parser not active') {
                console.log('Parser is not active');
                Swal.fire({
                    title: 'Парсер не активен',
                    // text: 'Парсер не активен',
                    icon: 'error',
                    timer: 3000,
                    showConfirmButton: true
                })
            } else if (pause_status) {
                $.ajax({
                    url: '/inst/action_parser/',
                    method: 'POST',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'parsers_id': parsers_id,
                        'action': 'unpause'
                    },
                    success: function (result) {
                        console.log('unpause');
                    }
                })
            } else {
                $.ajax({
                    url: '/inst/action_parser/',
                    method: 'POST',
                    data: {
                        'csrfmiddlewaretoken': '{{ csrf_token }}',
                        'parsers_id': parsers_id,
                        'action': 'pause'
                    },
                    success: function (result) {
                        console.log('pause');
                    }
                })
            }
        }

        function stop(parsers_id) {
            $.ajax({
                url: '',
                method: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'parsers_id': parsers_id,
                    'action': 'stop'
                },
                success: function (result) {
                    console.log('stop');
                }
            })
        }

        $('#addNewTagBTN').on('click', function () {
            let newTag = $('#TegInput').val();
            $("#addedTags").append('<li class="dropdown-input"><label><input class="inputTags" type="checkbox" value="' + newTag + '" checked>' + newTag + '</label></li>');
            $("#TegInput").val('');
        });

        $('#addNewGroupBTN').on('click', function () {
            let newGroup = $('#GroupInput').val();
            $("#addedGroups").append('<li class="dropdown-input"><label><input class="inputGroups"  type="checkbox" value="' + newGroup + '"  checked>' + newGroup + '</label></li>');
            $("#GroupInput").val('');
        });

        var parser_settings_id;
        $('.settingBTN').on('click', function () {
            let childElem = this.children[1];
            let parserID = childElem.innerHTML;
            parser_settings_id = parserID;
        });

        $('.settingApplyBTN').on('click', function () {
            var checkBoxesTags = [];
            $('.inputTags:checkbox:checked').each(function () {
                checkBoxesTags.push(this.value);
            });
            var checkBoxesGroups = [];
            $('.inputGroups:checkbox:checked').each(function () {
                checkBoxesGroups.push(this.value);
            });

            let location = $('#Location').val();
            let photo = $('#Photo').val();
            let thread = $('#Thread').val();
            let folder = $('#Folder').val();
            let result = location.match(/(\d*)\/([\w-]+)\/$/);
            let pageId = result[1];
            let pageFlag = result[2];
            let PackAmount = $('#PackAmount').val();

            $.ajax({
                url: '/inst/set_filter_settings/',
                method: 'GET',
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                data: {
                    'ID': parser_settings_id,
                    'Tags': checkBoxesTags,
                    'Groups': checkBoxesGroups,
                    'LocationId': pageId,
                    'LocationFlag': pageFlag,
                    'Photo': photo,
                    'Thread': thread,
                    'Folder': folder,
                    'PackAmount': PackAmount

                },
                success: function (result) {

                    if (result.success) {
                        Swal.fire({
                            title: 'Успешно!',
                            text: result.message,
                            icon: 'success',
                            timer: 3000,
                            showConfirmButton: true
                        }).then(() => {
                            // window.location.href = '';
                        });
                    } else {
                        Swal.fire({
                            title: 'Ошибка',
                            text: result.message,
                            icon: 'error',
                            timer: 4000,
                            showConfirmButton: true
                        });
                    }
                }
            })
        })

        $('.infoBTN').on('click', function () {
            var childElem = this.children[1];
            var parserID = childElem.innerHTML;

            $.ajax({
                url: '/inst/parser_status/',
                method: 'GET',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'parsers_id': parserID
                },
                success: function (data) {
                    if (data.status == 'success') {
                        $('#parserStatus').text(data.Status);
                        $('#parserStartTime').text(data.ParserStartTime);
                        $('#parserThread').text(data.Thread);
                        $('#parserTags').text(data.parserTags);
                        $('#parserGroups').text(data.parserGroups);
                        $('#parserLocation').text(data.parserLocation);
                        $('#parserPhotoByPage').text(data.PhotoByPage);
                        $('#parserFilesInPakage').text(data.FilesInPakage);
                        $('#parserParsedUserNames').text(data.ParsedUserNames);
                        $('#parserParsedPages').text(data.ParsedPages);
                    } else {
                        $('.modal-dialog').hide();

                        Swal.fire({
                            title: 'Фильтр парсера не установлен',
                            text: '',
                            icon: 'error',
                            timer: 4000,
                            showConfirmButton: true
                        }).then(() => {
                            window.location.href = '';
                        });
                    }
                }
            });
        });
    </script>
    <script>
        $('.createApplyBTN').on('click', function () {
            let address = $('#Address').val();
            let login = $('#Login').val();
            let password = $('#Password').val();
            let name = $('#CreateName').val();

            $.ajax({
                url: '/inst/create_parser/',
                method: 'POST',
                data: {
                    'csrfmiddlewaretoken': '{{ csrf_token }}',
                    'Ip': address,
                    'Login': login,
                    'Password': password,
                    'Name': name
                },
                success: function (result) {
                    if (result.success) {
                        Swal.fire({
                            title: 'Успешно!',
                            text: result.message,
                            icon: 'success',
                            timer: 2000,
                            showConfirmButton: true
                        }).then(() => {
                            window.location.reload();
                        });
                    } else {
                        Swal.fire({
                            title: 'Ошибка!',
                            text: result.message,
                            icon: 'error',
                            timer: 3000,
                            showConfirmButton: true
                        });
                    }
                }
            })
        })
    </script>
{% endblock side_script %}